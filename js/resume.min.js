document.addEventListener('DOMContentLoaded', () => {
    // --- 1. CONFIGURACIÓN Y SELECTORES ---
    const CONFIG = {
        validTabs: ['Bio', 'Experience', 'Education', 'Media'],
        mainNav: document.querySelector('#mainNav'),
        menuColapsable: document.getElementById('navbarResponsive'),
        btnHamburguesa: document.querySelector('.navbar-toggler'),
        tabLinks: document.querySelectorAll('.tab-link'),
        experienceTiles: document.querySelectorAll('.experience-tile'),
        revealElements: document.querySelectorAll('.reveal, .reveal-item, .publication-card, .scroll-reveal-section')
    };

    // --- 2. UTILIDADES ---
    const closeMobileMenu = () => {
        if (CONFIG.menuColapsable?.classList.contains('show')) {
            CONFIG.menuColapsable.classList.remove('show');
            if (CONFIG.btnHamburguesa) {
                CONFIG.btnHamburguesa.classList.add('collapsed');
                CONFIG.btnHamburguesa.setAttribute('aria-expanded', 'false');
            }
        }
    };

    const scrollToContent = () => {
        const tabContent = document.querySelector('.tab-content');
        if (!tabContent) return;

        const navbarHeight = CONFIG.mainNav ? CONFIG.mainNav.offsetHeight : 0;
        const offsetPosition = tabContent.getBoundingClientRect().top + window.pageYOffset - navbarHeight - 10;

        window.scrollTo({ top: offsetPosition, behavior: 'auto' });
    };

    // --- 3. LÓGICA DE PESTAÑAS (TABS) ---
    function switchTab(tabId, push = true) {
        const activeTab = document.getElementById(tabId);
        if (!activeTab) return;

        // Actualizar Paneles
        document.querySelectorAll('.tab-pane').forEach(tab => {
            tab.style.display = 'none';
            tab.classList.remove('active');
        });
        activeTab.style.display = 'block';
        activeTab.classList.add('active');

        // Actualizar Links
        CONFIG.tabLinks.forEach(link => {
            link.classList.toggle('active', link.getAttribute('data-tab') === tabId);
        });

        scrollToContent();
        controlVideos(tabId); // Pausar/Reproducir videos según la pestaña

        // Historial URL
        if (push && window.location.protocol !== 'file:') {
            try {
                window.history.pushState({ tab: tabId }, '', `/${tabId}`);
            } catch (e) { console.warn("Error en History API local"); }
        }
    }

    // --- 4. FILTROS DE EXPERIENCIA ---
    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            const filterValue = this.getAttribute('data-filter');
            CONFIG.experienceTiles.forEach(tile => {
                const categories = tile.getAttribute('data-category')?.split(',') || [];
                const isVisible = filterValue === 'all' || categories.includes(filterValue);

                tile.style.display = isVisible ? 'block' : 'none';
                tile.style.opacity = isVisible ? '1' : '0';
            });
        });
    });

    // --- 5. CONTROL DE MEDIA (VIDEOS) ---
    const controlVideos = (activeTabId) => {
        const allVideos = document.querySelectorAll('video');
        allVideos.forEach(v => {
            if (activeTabId === 'Media') {
                // Solo si el video es visible en el viewport (opcional)
                v.play().catch(() => {});
            } else {
                v.pause();
            }
        });
    };

    // --- 6. OBSERVERS (Animaciones y Auto-play) ---
    const generalObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Lógica para revelado de elementos
                if (entry.target.classList.contains('publication-card')) {
                    entry.target.classList.add('is-visible');
                } else if (entry.target.tagName === 'VIDEO') {
                    entry.target.play().catch(() => {});
                } else {
                    entry.target.classList.add('active');
                }
                // Si no es un video, dejamos de observar tras animar
                if (entry.target.tagName !== 'VIDEO') generalObserver.unobserve(entry.target);
            } else if (entry.target.tagName === 'VIDEO') {
                entry.target.pause();
            }
        });
    }, { threshold: 0.15 });

    CONFIG.revealElements.forEach(el => generalObserver.observe(el));
    document.querySelectorAll('video').forEach(v => generalObserver.observe(v));

    // --- 7. EVENTOS DE CLIC Y NAVEGACIÓN ---
    CONFIG.tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = link.getAttribute('data-tab');
            if (CONFIG.validTabs.includes(tabId)) {
                switchTab(tabId);
                closeMobileMenu();
            }
        });
    });

    // Botón "See More" de Bio
    const btnSeeMore = document.getElementById('see-more-btn');
    const bioHiddenContent = document.querySelector('.bio-hidden-content');
    if (btnSeeMore && bioHiddenContent) {
        btnSeeMore.addEventListener('click', () => {
            const isHidden = bioHiddenContent.style.display === 'none' || !bioHiddenContent.style.display;
            bioHiddenContent.style.display = isHidden ? 'block' : 'none';
            btnSeeMore.textContent = isHidden ? 'See Less' : 'See More';
        });
    }

    // --- 8. INICIALIZACIÓN ---
    const init = () => {
        const path = window.location.pathname.replace('/', '');
        const initialTab = CONFIG.validTabs.includes(path) ? path : 'Bio';
        switchTab(initialTab, false);

        // Animación entrada tiles
        CONFIG.experienceTiles.forEach((tile, i) => {
            setTimeout(() => {
                tile.style.opacity = '1';
                tile.style.transform = 'translateY(0)';
            }, 400 + (i * 100));
        });
    };

    window.addEventListener('popstate', (e) => {
        if (e.state?.tab) switchTab(e.state.tab, false);
    });

    init();
});