document.addEventListener('DOMContentLoaded', () => {
    // --- 1. CONFIGURACIÃ“N Y SELECTORES ---
    const CONFIG = {
        validTabs: ['Bio', 'Experience', 'Education', 'Media'],
        mainNav: document.querySelector('#mainNav'),
        menuColapsable: document.getElementById('navbarResponsive'),
        btnHamburguesa: document.querySelector('.navbar-toggler'),
        tabLinks: document.querySelectorAll('.tab-link'),
        experienceTiles: document.querySelectorAll('.experience-tile'),
        revealElements: document.querySelectorAll('.reveal, .reveal-item, .publication-card, .scroll-reveal-section'),
        allVideos: document.querySelectorAll('video'),
        videoFrames: document.querySelectorAll('.video-frame') // ğŸ‘ˆ NUEVO
    };

    // --- 2. OPTIMIZACIÃ“N INICIAL DE VIDEOS ---
    CONFIG.allVideos.forEach(video => {
        video.setAttribute('playsinline', '');
        video.setAttribute('preload', 'none');
        video.muted = true;
        video.controls = false;
    });

    // --- 2.5 CLICK-TO-LOAD (NUEVO) ---
    CONFIG.videoFrames.forEach(frame => {
        const video = frame.querySelector('video');
        const btn = frame.querySelector('.video-play');

        if (!video || !btn) return;

        btn.addEventListener('click', () => {
            // Pausa todos los demÃ¡s videos
            CONFIG.allVideos.forEach(v => {
                if (v !== video) {
                    v.pause();
                    v.currentTime = 0;
                }
            });

            // Carga real del video
            if (!video.src) {
                video.src = video.dataset.src;
            }

            video.controls = true;
            video.play().catch(() => { });
            btn.remove();
        });
    });

    // --- 3. UTILIDADES ---
    const closeMobileMenu = () => {
        if (CONFIG.menuColapsable?.classList.contains('show')) {
            CONFIG.menuColapsable.classList.remove('show');
            CONFIG.btnHamburguesa?.classList.add('collapsed');
            CONFIG.btnHamburguesa?.setAttribute('aria-expanded', 'false');
        }
    };

    const scrollToContent = () => {
        const tabContent = document.querySelector('.tab-content');
        if (!tabContent) return;
        const navbarHeight = CONFIG.mainNav ? CONFIG.mainNav.offsetHeight : 0;
        const offsetPosition =
            tabContent.getBoundingClientRect().top + window.pageYOffset - navbarHeight - 10;
        window.scrollTo({ top: offsetPosition, behavior: 'auto' });
    };

    // --- 4. LÃ“GICA DE TABS ---
    function switchTab(tabId, push = true) {
        const activeTab = document.getElementById(tabId);
        if (!activeTab) return;

        document.querySelectorAll('.tab-pane').forEach(tab => {
            tab.style.display = 'none';
            tab.classList.remove('active');
        });

        activeTab.style.display = 'block';
        activeTab.classList.add('active');

        CONFIG.tabLinks.forEach(link => {
            link.classList.toggle('active', link.getAttribute('data-tab') === tabId);
        });

        scrollToContent();

        // Pausar todos los videos al salir de Media
        if (tabId !== 'Media') {
            CONFIG.allVideos.forEach(v => v.pause());
        }

        if (push && window.location.protocol !== 'file:') {
            try {
                window.history.pushState({ tab: tabId }, '', `/${tabId}`);
            } catch { }
        }
    }

    // --- 5. OBSERVER (SOLO PARA ANIMACIONES, NO VIDEOS) ---
    const generalObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (!entry.isIntersecting) return;

            const el = entry.target;
            const className =
                el.classList.contains('publication-card') ? 'is-visible' : 'active';

            el.classList.add(className);
            generalObserver.unobserve(el);
        });
    }, {
        threshold: 0.15
    });

    CONFIG.revealElements.forEach(el => generalObserver.observe(el));

    // --- 6. EVENTOS ---
    CONFIG.tabLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const tabId = link.getAttribute('data-tab');
            if (CONFIG.validTabs.includes(tabId)) {
                switchTab(tabId);
                closeMobileMenu();
            }
        });
    });

    // --- 7. INICIALIZACIÃ“N ---
    const init = () => {
        const path = window.location.pathname.replace('/', '');
        const initialTab = CONFIG.validTabs.includes(path) ? path : 'Bio';
        switchTab(initialTab, false);

        CONFIG.experienceTiles.forEach((tile, i) => {
            setTimeout(() => {
                tile.style.opacity = '1';
                tile.style.transform = 'translateY(0)';
            }, 400 + i * 100);
        });
    };

    window.addEventListener('popstate', e => {
        if (e.state?.tab) switchTab(e.state.tab, false);
    });

    init();
});
