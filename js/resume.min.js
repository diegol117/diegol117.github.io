document.addEventListener('DOMContentLoaded', () => {
    // --- 1. CONFIGURACIÓN Y SELECTORES ---
    const CONFIG = {
        validTabs: ['Bio', 'Experience', 'Education', 'Media'],
        mainNav: document.querySelector('#mainNav'),
        menuColapsable: document.getElementById('navbarResponsive'),
        btnHamburguesa: document.querySelector('.navbar-toggler'),
        tabLinks: document.querySelectorAll('.tab-link'),
        experienceTiles: document.querySelectorAll('.experience-tile'),
        revealElements: document.querySelectorAll('.reveal, .reveal-item, .publication-card, .scroll-reveal-section'),
        allVideos: document.querySelectorAll('video')
    };

    // --- 2. OPTIMIZACIÓN INICIAL DE VIDEOS (Prevenir Lag) ---
    CONFIG.allVideos.forEach(video => {
        video.setAttribute('playsinline', ''); // Evita que iOS abra el reproductor nativo
        video.setAttribute('preload', 'none');  // No descarga nada hasta que se visualiza
        video.muted = true;                     // Requisito para autoplay fluido
        video.style.willChange = 'transform';   // Fuerza al móvil a usar aceleración por GPU
    });

    // --- 3. UTILIDADES ---
    const closeMobileMenu = () => {
        if (CONFIG.menuColapsable?.classList.contains('show')) {
            CONFIG.menuColapsable.classList.remove('show');
            CONFIG.btnHamburguesa?.classList.add('collapsed');
            CONFIG.btnHamburguesa?.setAttribute('aria-expanded', 'false');
        }
    };

    const scrollToContent = () => {
        const tabContent = document.querySelector('.tab-content');
        if (!tabContent) return;
        const navbarHeight = CONFIG.mainNav ? CONFIG.mainNav.offsetHeight : 0;
        const offsetPosition = tabContent.getBoundingClientRect().top + window.pageYOffset - navbarHeight - 10;
        window.scrollTo({ top: offsetPosition, behavior: 'auto' });
    };

    // --- 4. LÓGICA DE PESTAÑAS (TABS) ---
    function switchTab(tabId, push = true) {
        const activeTab = document.getElementById(tabId);
        if (!activeTab) return;

        document.querySelectorAll('.tab-pane').forEach(tab => {
            tab.style.display = 'none';
            tab.classList.remove('active');
        });
        activeTab.style.display = 'block';
        activeTab.classList.add('active');

        CONFIG.tabLinks.forEach(link => {
            link.classList.toggle('active', link.getAttribute('data-tab') === tabId);
        });

        scrollToContent();

        // Si salimos de 'Media', pausamos todos los videos para liberar CPU
        if (tabId !== 'Media') {
            CONFIG.allVideos.forEach(v => v.pause());
        }

        if (push && window.location.protocol !== 'file:') {
            try {
                window.history.pushState({ tab: tabId }, '', `/${tabId}`);
            } catch (e) { console.warn("Error en History API"); }
        }
    }

    // --- 5. OBSERVERS (Animaciones y Auto-play Inteligente) ---
    const generalObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const el = entry.target;

            if (entry.isIntersecting) {
                // LÓGICA PARA VIDEOS (Solo cargan y suenan cuando se ven)
                if (el.tagName === 'VIDEO') {
                    if (el.getAttribute('preload') === 'none') {
                        el.setAttribute('preload', 'metadata'); // Carga solo lo necesario para empezar
                    }
                    el.play().catch(() => {}); // El catch evita errores si el usuario no ha interactuado
                }
                // LÓGICA PARA ANIMACIONES
                else {
                    const className = el.classList.contains('publication-card') ? 'is-visible' : 'active';
                    el.classList.add(className);
                    generalObserver.unobserve(el); // Dejar de observar elementos estáticos
                }
            } else if (el.tagName === 'VIDEO') {
                el.pause(); // Pausa inmediata si el video sale de la pantalla
            }
        });
    }, {
        threshold: 0.1, // Se activa rápido al asomar
        rootMargin: "0px 0px 50px 0px" // Empieza a cargar 50px antes de que aparezca
    });

    CONFIG.revealElements.forEach(el => generalObserver.observe(el));
    CONFIG.allVideos.forEach(v => generalObserver.observe(v));

    // --- 6. EVENTOS Y FILTROS ---
    CONFIG.tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = link.getAttribute('data-tab');
            if (CONFIG.validTabs.includes(tabId)) {
                switchTab(tabId);
                closeMobileMenu();
            }
        });
    });

    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const filterValue = this.getAttribute('data-filter');
            CONFIG.experienceTiles.forEach(tile => {
                const categories = tile.getAttribute('data-category')?.split(',') || [];
                const isVisible = filterValue === 'all' || categories.includes(filterValue);
                tile.style.display = isVisible ? 'block' : 'none';
                tile.style.opacity = isVisible ? '1' : '0';
            });
        });
    });

    const btnSeeMore = document.getElementById('see-more-btn');
    const bioHiddenContent = document.querySelector('.bio-hidden-content');
    if (btnSeeMore && bioHiddenContent) {
        btnSeeMore.addEventListener('click', () => {
            const isHidden = bioHiddenContent.style.display === 'none' || !bioHiddenContent.style.display;
            bioHiddenContent.style.display = isHidden ? 'block' : 'none';
            btnSeeMore.textContent = isHidden ? 'See Less' : 'See More';
        });
    }

    // --- 7. INICIALIZACIÓN ---
    const init = () => {
        const path = window.location.pathname.replace('/', '');
        const initialTab = CONFIG.validTabs.includes(path) ? path : 'Bio';
        switchTab(initialTab, false);

        CONFIG.experienceTiles.forEach((tile, i) => {
            setTimeout(() => {
                tile.style.opacity = '1';
                tile.style.transform = 'translateY(0)';
            }, 400 + (i * 100));
        });
    };

    window.addEventListener('popstate', (e) => {
        if (e.state?.tab) switchTab(e.state.tab, false);
    });

    init();
});