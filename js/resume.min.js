document.addEventListener('DOMContentLoaded', function () {

    // --- 1. CONFIGURACIÓN Y VARIABLES ---
    const validTabs = ['Bio', 'Experience', 'Education', 'Media'];
    const menuColapsable = document.getElementById('navbarResponsive');
    const botonHamburguesa = document.querySelector('.navbar-toggler');
    const mainNav = document.querySelector('#mainNav');

    // --- 2. FUNCIÓN DE DESPLAZAMIENTO (Salto Inmediato) ---
    function scrollToContent() {
        const tabContent = document.querySelector('.tab-content');
        if (tabContent) {
            const navbarHeight = mainNav ? mainNav.offsetHeight : 0;

            // Calculamos la posición exacta
            const elementPosition = tabContent.getBoundingClientRect().top + window.pageYOffset;
            const offsetPosition = elementPosition - navbarHeight - 10;

            // 'auto' hace que el salto sea instantáneo, sin deslizamiento
            window.scrollTo({
                top: offsetPosition,
                behavior: 'auto'
            });
        }
    }

// --- 3. LÓGICA DE CAMBIO DE PESTAÑAS ---
function switchTab(tabId, push = true) {
    const activeTab = document.getElementById(tabId);
    if (!activeTab) return;

    document.querySelectorAll('.tab-pane').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });

    activeTab.style.display = 'block';
    activeTab.classList.add('active');

    document.querySelectorAll('.tab-link').forEach(link => {
        link.classList.toggle('active', link.getAttribute('data-tab') === tabId);
    });

    scrollToContent();

    // CORRECCIÓN AQUÍ: Evita el error en archivos locales
    if (push && window.location.protocol !== 'file:') {
        try {
            window.history.pushState({ tab: tabId }, '', '/' + tabId);
        } catch (e) {
            console.warn("No se pudo actualizar la URL (probablemente estás en modo local)");
        }
    }
}

// --- 4. EVENTOS DE CLIC ---
document.querySelectorAll('.tab-link').forEach(link => {
    link.addEventListener('click', function (e) {
        e.preventDefault();
        const tabId = this.getAttribute('data-tab');

        if (validTabs.includes(tabId)) {
            switchTab(tabId);

            // CERRAR MENÚ MÓVIL (Forzado manual para evitar bloqueos)
            const menuColapsable = document.getElementById('navbarResponsive');
            if (menuColapsable && menuColapsable.classList.contains('show')) {
                // Usamos el método manual ya que el error de Security puede bloquear jQuery
                menuColapsable.classList.remove('show');
                const btn = document.querySelector('.navbar-toggler');
                if(btn) {
                    btn.classList.add('collapsed');
                    btn.setAttribute('aria-expanded', 'false');
                }
            }
        }
    });
});
    // --- 5. ANIMACIONES AL HACER SCROLL (Intersection Observer) ---
    const revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const target = entry.target;
                if (target.classList.contains('publication-card')) {
                    target.classList.add('is-visible');
                } else {
                    target.classList.add('active');
                }
                revealObserver.unobserve(target);
            }
        });
    }, { threshold: 0.15 });

    document.querySelectorAll('.reveal, .reveal-item, .publication-card, .scroll-reveal-section')
            .forEach(el => revealObserver.observe(el));

    // --- 6. FILTRO DE EXPERIENCIA (Tiles) ---
    const filterButtons = document.querySelectorAll('.filter-btn');
    const experienceTiles = document.querySelectorAll('.experience-tile');

    filterButtons.forEach(button => {
        button.addEventListener('click', function () {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const filterValue = this.getAttribute('data-filter');

            experienceTiles.forEach(tile => {
                const categories = tile.getAttribute('data-category').split(',');
                const isVisible = filterValue === 'all' || categories.includes(filterValue);

                tile.style.display = isVisible ? 'block' : 'none';
                tile.style.opacity = isVisible ? '1' : '0';
            });
        });
    });

    // --- 7. INICIALIZACIÓN ---
    function init() {
        const path = window.location.pathname.replace('/', '');
        const initialTab = validTabs.includes(path) ? path : 'Bio';
        switchTab(initialTab, false);

        // Efecto de entrada para los tiles
        experienceTiles.forEach((tile, i) => {
            setTimeout(() => {
                tile.style.opacity = '1';
                tile.style.transform = 'translateY(0)';
            }, 400 + (i * 100));
        });
    }

    window.addEventListener('popstate', (e) => {
        if (e.state && e.state.tab) switchTab(e.state.tab, false);
    });

    init();
});

const btn = document.getElementById('see-more-btn');
const hiddenContent = document.querySelector('.bio-hidden-content');

btn.addEventListener('click', () => {
  if (hiddenContent.style.display === 'none') {
    hiddenContent.style.display = 'block';
    btn.textContent = 'See Less';
  } else {
    hiddenContent.style.display = 'none';
    btn.textContent = 'See More';
  }
});
